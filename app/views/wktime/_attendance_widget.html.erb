<% wktime_helper = Object.new.extend(WktimeHelper) %>
<% if wktime_helper.isChecked('te_save_geo_location') ||
		wktime_helper.isChecked('att_save_geo_location') ||
		wktime_helper.isChecked('crm_save_geo_location') %>
			<%= javascript_include_tag 'geo_location', :plugin => "redmine_wktime" %>
<% end %>
<% 
   lastAttnEntries = wktime_helper.findLastAttnEntry(true)
   if !lastAttnEntries.blank? 
  	  @lastAttnEntry = lastAttnEntries[0]
   end
%>
<style>
	#clockINOUT, #issueLog {
		float: right;
		display: flex;
		flex-direction: row-reverse;
		cursor: pointer;
		margin-left: 10px;
	}
	#appendlabel, #issue-time, #issue-tracker{
		padding-top: 5px;
		padding-left: 4px;
		font-size: 13px;
	}
	#startdiv, #enddiv{
		float: right;
	}
	#issueLog .drdn-items > * {
		color: #555 !important;
	}
	#issueLog .drdn-content {width:280px;}
</style>
<% if wktime_helper.isChecked("wktime_enable_clock_in_out") && wktime_helper.isChecked("wktime_enable_attendance_module") && User.current.logged? && wktime_helper.checkViewPermission %>	
	<% if !@lastAttnEntry.blank?
			if(@lastAttnEntry.end_time.blank? && @lastAttnEntry.start_time > 24.hour.ago)
				hideStart = true
				hideEnd = false
				imglabel = "end"
				remaininghr =  (wktime_helper.computeWorkedHours(@lastAttnEntry.start_time, Time.now.localtime, false))
			else
				hideStart = false
				hideEnd = true
			end
			imglabel = (@lastAttnEntry.end_time.blank? && @lastAttnEntry.start_time > 24.hour.ago ? "end" : "start")
		else
			hideStart = false
			hideEnd = true
		end
		 
		imgname = "#{imglabel}" == "start" ? "clockin1.jpg" : "clockout1.jpg"
		totalhours = (wktime_helper.totalhours)*3600
		totalhours = (hideStart ? ( !remaininghr.blank? ? remaininghr.round(0)+totalhours : totalhours) : totalhours )
		totalhours1 = Time.at(totalhours).utc.strftime("%H:%M")
		host_with_subdir = wktime_helper.getHostAndDir(request)
	%>
	<%=h hidden_field_tag('clockinout_url',  "#{url_for(:controller => 'wkbase', :action => 'updateClockInOut', :host => host_with_subdir, :only_path => true)}" )  %>
	<div style="clear: both;"></div>
	<div id="clockINOUT">
		<span id="appendlabel"><%= totalhours1 %></span>
		<div id="startdiv">
			<%= image_tag("widgetclockin.png", :id => 'clockin' , :plugin => "redmine_wktime", :style => hideStart ? "display:none;" : "display:block;" ) %>		
		</div>
		<div id="enddiv">
			<%= image_tag("widgetclockout.png", :id => 'clockout', :plugin => "redmine_wktime", :style => hideEnd ? "display:none;" : "display:block;") %>		
		</div>
	</div>
	<div style="clear: both;"></div>
<% end %>

<!-- Time Tracker-->
<% if wktime_helper.isChecked("label_enable_issue_logger") && User.current.logged? && wktime_helper.checkViewPermission
		lastTimeEntry = WkSpentFor.lastEntry.first
		if lastTimeEntry.present?
			trackerName = lastTimeEntry.name + '#' + lastTimeEntry.issue_id.to_s
			if(lastTimeEntry.end_on.blank? && lastTimeEntry.start_on > 24.hour.ago)
				remainingTimehr = (wktime_helper.computeWorkedHours(lastTimeEntry.start_on, Time.now.localtime, false))
			end
		end
		totalhours = remainingTimehr.present? ? remainingTimehr.round(0) : 0.0 
		issueHour = Time.at(totalhours).utc.strftime("%H:%M") 
		imgName = remainingTimehr.present? ? "finish" : "start"
		image = image_tag(imgName + '.png', plugin: "redmine_wktime")
		trigger = content_tag("span", image, id: 'issueImg', class: "drdn-trigger")
		issueURL = "/wktime/getissues?autocomplete=true"
		issue = text_field_tag("issue", "", id: "issues-quick-search", class: "autocomplete", data: {automcomplete_url: issueURL},
			autocomplete: "off", placeholder: "Select Issue")
		content = lastTimeEntry.blank? ? content_tag("div", content_tag("div", issue, class: "quick-search") +
			content_tag("div", nil, class: "drdn-items issues"), class: "drdn-content", id: "issue-content" ) : ""
		issueTime = content_tag("span", issueHour, class: "drdn-trigger", id: "issue-time")
		issueTracker = content_tag("span", trackerName, class: "drdn-trigger", id: "issue-tracker",
			style: "display:" + (remainingTimehr.present? ?  "block" : "none"))
%>
	<%= hidden_field_tag('imgName', imgName ) %>
	<%= hidden_field_tag('projectID', @project ? @project.id : "" ) %>
	<%= content_tag("div", issueTime + issueTracker + trigger + content, id: "issueLog", class: "drdn") %>
	<div style="clear: both;"></div>
<% end %>

<!-- Spent time show on map -->
<% if controller_name == "timelog" && action_name == "index" && wktime_helper.isChecked('att_save_geo_location') %>
	<% show_on_map = params[:show_on_map].present? && params[:show_on_map] %>
	<div id="show_map_filter" >
		<label style="padding-left:5px">
			<%= check_box_tag('show_on_map', true, params[:show_on_map] || false, onclick: '$("#query_form").submit(); return false;') %><%= l(:label_show_on_map) %>
		</label>
	</div>
	<script>
		$(function(){
			$('#spent_type').parent('td').after('<td id="showmap_header"></td>');
			$('#show_map_filter').appendTo('#showmap_header');
		});
	</script>
	<% if show_on_map %>
		<script>
			$(function(){
				$('.list.odd-even.time-entries').css({ width:'49%', float: 'left', 'table-layout': 'fixed' });
				$('.list.odd-even.time-entries').after($("#mapheader"));
			});
		</script>
		<%= render partial: "wkgeolocation/show_on_map", locals: { entries: @entries, height: '96%', width: '49%', model: 'spent_for' } %>
	<% end %>
<% end %>